<!-- monitoring/templates/monitoring/dashboard.html -->
{% extends "monitoring/base.html" %}
{% block extra_head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Основной фон страницы */
        body {
            background-color: #fcf9e9;
            margin: 0;
            padding: 20px;
        }

        .charts-row {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 20px;
            width: 100%;
        }
        .chart-card {
            flex: 1;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            background: #fefdf6;
            border: 1px solid #e8dfc8;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(92, 71, 25, 0.08);
        }
        .chart-container {
            flex: 1;
            position: relative;
            width: 100%;
        }
        .chart-card canvas {
            width: 100% !important;
            height: 250px !important;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: #fefdf6;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #4a7b9d;
            border: 1px solid #e8dfc8;
            box-shadow: 0 2px 6px rgba(92, 71, 25, 0.06);
        }
        .stat-card h3 {
            color: #6b5c43;
            margin: 0 0 10px 0;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
            color: #5d4037;
        }
        .status-active {
            color: #4a7b9d;
        }
        .status-inactive {
            color: #8a7e6b;
        }
        .status-isolated {
            color: #c44536;
        }
        .card {
            background: #fefdf6;
            border: 1px solid #e8dfc8;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(92, 71, 25, 0.08);
            margin-bottom: 20px;
        }
        .card h2 {
            color: #5d4037;
            margin: 0 0 15px 0;
            font-weight: 600;
            font-size: 1.2rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 8px;
            overflow: hidden;
            background-color: #fefdf6;
        }
        th {
            background-color: #f5f0e1;
            color: #6b5c43;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 12px 14px;
            text-align: left;
            border-bottom: 1px solid #f0e9d7;
        }
        td {
            padding: 10px 14px;
            text-align: left;
            border-bottom: 1px solid #f0e9d7;
            color: #6b5c43;
        }
        tr:hover {
            background-color: #faf8f0;
        }
        .empty-state {
            text-align: center;
            color: #a89f8a;
            padding: 30px;
            font-style: italic;
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .charts-row {
                flex-direction: column;
            }
            .chart-card {
                min-height: 250px;
            }
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            .stat-number {
                font-size: 1.5rem;
            }
        }
    </style>
{% endblock %}

{% block content %}
<!-- Системная статистика в виде карточек -->
<div class="stats-grid">
    <div class="stat-card">
        <h3>Total Devices</h3>
        <p class="stat-number">{{ total_devices }}</p>
    </div>
    <div class="stat-card">
        <h3>Active Devices</h3>
        <p class="stat-number status-active">{{ active_devices }}</p>
    </div>
    <div class="stat-card">
        <h3>Inactive Devices</h3>
        <p class="stat-number status-inactive">{{ inactive_devices }}</p>
    </div>
    <div class="stat-card">
        <h3>Isolated Devices</h3>
        <p class="stat-number status-isolated">{{ isolated_devices }}</p>
    </div>
    <div class="stat-card">
        <h3>Total Incidents</h3>
        <p class="stat-number">{{ total_incidents }}</p>
    </div>
</div>

<!-- Три графика в одном ряду на всю ширину -->
<div class="charts-row">
    <!-- Круговая диаграмма угроз -->
    <div class="chart-card">
        <h2>Threat Distribution</h2>
        <div class="chart-container">
            <canvas id="threatChart"></canvas>
        </div>
    </div>

    <!-- График состояния устройств -->
    <div class="chart-card">
        <h2>Devices Status</h2>
        <div class="chart-container">
            <canvas id="deviceStatusChart"></canvas>
        </div>
    </div>

    <!-- График инцидентов по времени -->
    <div class="chart-card">
        <h2>Incidents Timeline</h2>
        <div class="chart-container">
            <canvas id="incidentsOverTimeChart"></canvas>
        </div>
    </div>
</div>

<div class="charts-row">
    <div class="chart-card">
        <h2>Device Activity (24h)</h2>
        <div class="chart-container">
            <canvas id="deviceActivityChart"></canvas>
        </div>
    </div>
    <div class="chart-card">
        <h2>Top Devices by Incidents</h2>
        <div class="chart-container">
            <canvas id="topDevicesChart"></canvas>
        </div>
    </div>
    <div class="chart-card">
        <h2>Incident Severity</h2>
        <div class="chart-container">
            <canvas id="severityChart"></canvas>
        </div>
    </div>
</div>

<!-- Таблица последних инцидентов -->
<div class="card">
    <h2>Recent Incidents</h2>
    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Device</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                {% for inc in recent_incidents %}
                <tr>
                    <td>{{ inc.timestamp|date:"Y-m-d H:i:s" }}</td>
                    <td>{{ inc.device.hostname }}</td>
                    <td>{{ inc.description }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="3" class="empty-state">
                        No incidents reported
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    // Круговая диаграмма угроз
    const threatCtx = document.getElementById('threatChart').getContext('2d');
    new Chart(threatCtx, {
        type: 'pie',
        data: {
            labels: {{ threat_labels|safe }},
            datasets: [{
                data: {{ threat_data|safe }},
                backgroundColor: [
                    '#c44536', '#4a7b9d', '#d68c45', '#8a7e6b',
                    '#5d4037', '#6b5c43', '#a89f8a', '#f0e9d7'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        boxWidth: 12,
                        font: { size: 11 },
                        color: '#6b5c43'
                    }
                }
            }
        }
    });

    // График состояния устройств
    const statusCtx = document.getElementById('deviceStatusChart').getContext('2d');
    new Chart(statusCtx, {
        type: 'bar',
        data: {
            labels: ['Active', 'Inactive', 'Isolated'],
            datasets: [{
                label: 'Number of Devices',
                data: [{{ active_devices }}, {{ inactive_devices }}, {{ isolated_devices }}],
                backgroundColor: [
                    'rgba(74, 123, 157, 0.8)',
                    'rgba(138, 126, 107, 0.8)',
                    'rgba(196, 69, 54, 0.8)'
                ],
                borderColor: [
                    'rgb(74, 123, 157)',
                    'rgb(138, 126, 107)',
                    'rgb(196, 69, 54)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        color: '#6b5c43'
                    },
                    grid: {
                        color: '#f0e9d7'
                    }
                },
                y: {
                    ticks: {
                        color: '#6b5c43'
                    },
                    grid: {
                        color: '#f0e9d7'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // График инцидентов по времени
    const timeCtx = document.getElementById('incidentsOverTimeChart').getContext('2d');
    new Chart(timeCtx, {
        type: 'line',
        data: {
            labels: {{ incidents_over_time_labels|safe }},
            datasets: [{
                label: 'Number of Incidents',
                data: {{ incidents_over_time_data|safe }},
                borderColor: '#4a7b9d',
                backgroundColor: 'rgba(74, 123, 157, 0.1)',
                tension: 0.1,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        color: '#6b5c43'
                    },
                    grid: {
                        color: '#f0e9d7'
                    }
                },
                x: {
                    ticks: {
                        color: '#6b5c43'
                    },
                    grid: {
                        color: '#f0e9d7'
                    }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        color: '#6b5c43'
                    }
                }
            }
        }
    });

    // График активности устройств за 24 часа
    const activityCtx = document.getElementById('deviceActivityChart').getContext('2d');
    new Chart(activityCtx, {
        type: 'line',
        data: {
            labels: {{ device_activity_labels|safe }},
            datasets: [{
                label: 'Active Devices',
                data: {{ device_activity_data|safe }},
                borderColor: '#4a7b9d',
                backgroundColor: 'rgba(74, 123, 157, 0.1)',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#6b5c43',
                        stepSize: 1
                    },
                    grid: {
                        color: '#f0e9d7'
                    }
                },
                x: {
                    ticks: {
                        color: '#6b5c43'
                    },
                    grid: {
                        color: '#f0e9d7'
                    }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        color: '#6b5c43'
                    }
                }
            }
        }
    });

    // Топ устройств по инцидентам
    const topDevicesCtx = document.getElementById('topDevicesChart').getContext('2d');
    new Chart(topDevicesCtx, {
        type: 'bar',
        data: {
            labels: {{ top_device_labels|safe }},
            datasets: [{
                label: 'Incidents',
                data: {{ top_device_data|safe }},
                backgroundColor: 'rgba(93, 64, 55, 0.8)',
                borderColor: 'rgb(93, 64, 55)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#6b5c43',
                        stepSize: 1
                    },
                    grid: {
                        color: '#f0e9d7'
                    }
                },
                x: {
                    ticks: {
                        color: '#6b5c43',
                        maxRotation: 45,
                        minRotation: 45
                    },
                    grid: {
                        color: '#f0e9d7'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // Распределение по критичности
    const severityCtx = document.getElementById('severityChart').getContext('2d');
    new Chart(severityCtx, {
        type: 'doughnut',
        data: {
            labels: {{ severity_labels|safe }},
            datasets: [{
                data: {{ severity_data|safe }},
                backgroundColor: {{ severity_colors|safe }},
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        boxWidth: 12,
                        font: { size: 11 },
                        color: '#6b5c43'
                    }
                }
            }
        }
    });
</script>
{% endblock %}